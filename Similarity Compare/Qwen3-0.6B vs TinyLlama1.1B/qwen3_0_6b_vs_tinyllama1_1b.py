# -*- coding: utf-8 -*-
"""QWEN3-0.6B vs TinyLlama1.1B

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/#fileId=https%3A//storage.googleapis.com/kaggle-colab-exported-notebooks/kylian007/qwen3-0-6b-vs-tinyllama1-1b.d68dc6eb-9818-4f6a-9398-246019af98e1.ipynb%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Dgcp-kaggle-com%2540kaggle-161607.iam.gserviceaccount.com/20251113/auto/storage/goog4_request%26X-Goog-Date%3D20251113T092332Z%26X-Goog-Expires%3D259200%26X-Goog-SignedHeaders%3Dhost%26X-Goog-Signature%3D104ead702f7c5dcffcd7b123e8bc6a278016a7f642db626d053e32f4d10d124f8ee14c57660d0583bef0e2dc711df53d41237c5d4f34ceff11cde0551e9a427b8003708e74da732ca12c817671feb26e0540e46aba7326943de33f6d2267edbfc2b088372c3be3f40e4ba6970cc79082a2f3cf02480cfd755a6195321701bb1fe7a5de07efa18f66171b133cffaa60be3f1f90a25d9253fafd4e89a6bcaac97d36c84e21668a55ad267f14b9659d1efea37f63d1cd4cd2d47a639ccde5cd10f07e1c780a98005291e4733d7f405cc74ae212498b4eae6ab473da61dd3a272c22b83c8d8d15b71033c5ef51a41df73778d7e455b35a22e1e4ed4231a4a5ea7076
"""

# IMPORTANT: SOME KAGGLE DATA SOURCES ARE PRIVATE
# RUN THIS CELL IN ORDER TO IMPORT YOUR KAGGLE DATA SOURCES.
import kagglehub
kagglehub.login()

# IMPORTANT: RUN THIS CELL IN ORDER TO IMPORT YOUR KAGGLE DATA SOURCES,
# THEN FEEL FREE TO DELETE THIS CELL.
# NOTE: THIS NOTEBOOK ENVIRONMENT DIFFERS FROM KAGGLE'S PYTHON
# ENVIRONMENT SO THERE MAY BE MISSING LIBRARIES USED BY YOUR
# NOTEBOOK.

kylian007_isscore_path = kagglehub.dataset_download('kylian007/isscore')

print('Data source import complete.')

# -*- coding: utf-8 -*-
"""Qwen3-0.6B vs TinyLlama-1.1B Feature Similarity Analysis.ipynb

Automatically generated by Colab.
"""

!pip install transformers datasets sentence-transformers torch sae-lens
!pip install sae-lens transformer_lens transformers datasets torch matplotlib scikit-learn
!pip install sentence-transformers scikit-learn pandas numpy tqdm
!pip install groq

"""
Feature Similarity Analysis - Top 10 Most Similar Features
===========================================================
Finds and reports the top 10 Qwen3 features most similar to TinyLlama features.

Requirements:
    pip install sentence-transformers scikit-learn pandas numpy tqdm
"""

import os
import re
import numpy as np
import pandas as pd
from typing import List, Dict
import warnings
warnings.filterwarnings('ignore')

print("\n" + "="*80)
print("TOP 10 SIMILAR FEATURES ANALYSIS - Qwen3-0.6B vs TinyLlama-1.1B")
print("="*80 + "\n")

# Import dependencies
try:
    from sentence_transformers import SentenceTransformer
    from sklearn.metrics.pairwise import cosine_similarity
    from tqdm import tqdm
except ImportError as e:
    print(f"✗ Missing dependency: {e}")
    print("Install: pip install sentence-transformers scikit-learn pandas numpy tqdm")
    exit(1)


# ============================================================================
# PARSING FUNCTION
# ============================================================================

def parse_interpretability_report(filename: str) -> List[Dict]:
    """Parse interpretability report to extract features."""
    print(f"Parsing {filename}...")

    with open(filename, 'r', encoding='utf-8') as f:
        content = f.read()

    features = []
    sections = content.split('======================================================================')

    for section in sections:
        if not section.strip() or 'SUMMARY' in section or 'REPORT FOR' in section:
            continue

        # Extract feature info
        feat_match = re.search(r'Feature:\s*Feature\s*(\d+)\s*\((\w+)\s+sentiment\)', section)
        if not feat_match:
            continue

        # Extract interpretation
        interp_match = re.search(r'Llama 3 Interpretation:\s*\n(.*?)\n\nEvaluation', section, re.DOTALL)
        if not interp_match:
            continue

        # Extract correlation score (handle NaN)
        score_match = re.search(r'Overall.*?Correlation Score:\s*([-\d.]+|nan)', section, re.IGNORECASE)
        if not score_match:
            continue

        try:
            score = float(score_match.group(1))
        except ValueError:
            score = np.nan

        features.append({
            'feature_id': int(feat_match.group(1)),
            'sentiment_type': feat_match.group(2),
            'interpretation': interp_match.group(1).strip(),
            'correlation_score': score
        })

    print(f"✓ Found {len(features)} features")
    return features


# ============================================================================
# SIMILARITY COMPUTATION
# ============================================================================

def compute_similarity(text1: str, text2: str, model) -> float:
    """Compute cosine similarity between two texts."""
    emb1 = model.encode(text1, convert_to_tensor=False, show_progress_bar=False)
    emb2 = model.encode(text2, convert_to_tensor=False, show_progress_bar=False)

    emb1 = emb1.reshape(1, -1)
    emb2 = emb2.reshape(1, -1)

    return float(cosine_similarity(emb1, emb2)[0][0])


def find_best_matches(qwen_features, tinyllama_features, model):
    """For each Qwen3 feature, find the most similar TinyLlama feature."""
    print(f"\nComputing similarities...")
    print(f"Total comparisons: {len(qwen_features)} × {len(tinyllama_features)} = {len(qwen_features) * len(tinyllama_features)}")

    results = []

    for qwen_feat in tqdm(qwen_features, desc="Analyzing Qwen3 features"):
        best_score = -1
        best_tinyllama_feat = None

        # Compare against all TinyLlama features
        for tinyllama_feat in tinyllama_features:
            score = compute_similarity(
                qwen_feat['interpretation'],
                tinyllama_feat['interpretation'],
                model
            )

            if score > best_score:
                best_score = score
                best_tinyllama_feat = tinyllama_feat

        results.append({
            'qwen3_feature_id': qwen_feat['feature_id'],
            'qwen3_sentiment': qwen_feat['sentiment_type'],
            'qwen3_interpretation': qwen_feat['interpretation'],
            'qwen3_correlation_score': qwen_feat['correlation_score'],
            'tinyllama_feature_id': best_tinyllama_feat['feature_id'],
            'tinyllama_sentiment': best_tinyllama_feat['sentiment_type'],
            'tinyllama_interpretation': best_tinyllama_feat['interpretation'],
            'tinyllama_correlation_score': best_tinyllama_feat['correlation_score'],
            'similarity_score': best_score
        })

    return pd.DataFrame(results)


# ============================================================================
# TOP 10 REPORT GENERATION
# ============================================================================

def save_top10_report(results_df, output_filename):
    """Save a detailed report of top 10 most similar feature pairs."""
    print(f"\nGenerating top 10 report: {output_filename}")

    # Get top 10 by similarity score
    top10 = results_df.nlargest(10, 'similarity_score')

    with open(output_filename, 'w', encoding='utf-8') as f:
        f.write("="*80 + "\n")
        f.write("TOP 10 MOST SIMILAR FEATURES\n")
        f.write("Qwen3-0.6B SAE vs TinyLlama-1.1B SAE\n")
        f.write("="*80 + "\n\n")

        f.write(f"Total Qwen3 features analyzed: {len(results_df)}\n")
        f.write(f"Total TinyLlama features available: {results_df['tinyllama_feature_id'].nunique()}\n")
        f.write(f"Average similarity score (all): {results_df['similarity_score'].mean():.4f}\n")
        f.write(f"Top 10 average similarity: {top10['similarity_score'].mean():.4f}\n\n")

        # Summary table
        f.write("="*80 + "\n")
        f.write("SUMMARY TABLE - TOP 10 PAIRS\n")
        f.write("="*80 + "\n\n")

        f.write(f"{'Rank':<6} {'Qwen3 F':<10} {'TinyLlama F':<13} {'Similarity':<12} {'Qwen3 Corr':<13} {'TinyLlama Corr':<15}\n")
        f.write("-"*80 + "\n")

        for rank, (idx, row) in enumerate(top10.iterrows(), 1):
            f.write(f"{rank:<6} ")
            f.write(f"{row['qwen3_feature_id']:<10} ")
            f.write(f"{row['tinyllama_feature_id']:<13} ")
            f.write(f"{row['similarity_score']:.4f}      ")
            f.write(f"{row['qwen3_correlation_score']:>6.4f}       ")
            f.write(f"{row['tinyllama_correlation_score']:>6.4f}\n")

        f.write("\n\n")

        # Detailed analysis for each pair
        f.write("="*80 + "\n")
        f.write("DETAILED ANALYSIS - TOP 10 PAIRS\n")
        f.write("="*80 + "\n\n")

        for rank, (idx, row) in enumerate(top10.iterrows(), 1):
            f.write("="*80 + "\n")
            f.write(f"RANK {rank}\n")
            f.write("="*80 + "\n\n")

            # Qwen3 Feature
            f.write(f"QWEN3 FEATURE {row['qwen3_feature_id']}\n")
            f.write("-"*80 + "\n")
            f.write(f"Sentiment: {row['qwen3_sentiment'].upper()}\n")
            f.write(f"Interpretability Score: {row['qwen3_correlation_score']:.4f}\n\n")
            f.write("INTERPRETATION:\n")
            f.write(row['qwen3_interpretation'])
            f.write("\n\n")

            # TinyLlama Feature
            f.write(f"TINYLLAMA FEATURE {row['tinyllama_feature_id']}\n")
            f.write("-"*80 + "\n")
            f.write(f"Sentiment: {row['tinyllama_sentiment'].upper()}\n")
            f.write(f"Interpretability Score: {row['tinyllama_correlation_score']:.4f}\n\n")
            f.write("INTERPRETATION:\n")
            f.write(row['tinyllama_interpretation'])
            f.write("\n\n")

            # Similarity metrics
            f.write("SIMILARITY ANALYSIS\n")
            f.write("-"*80 + "\n")
            f.write(f"Semantic Similarity Score: {row['similarity_score']:.4f}\n")
            f.write(f"Sentiment Match: {'YES' if row['qwen3_sentiment'] == row['tinyllama_sentiment'] else 'NO'}\n")
            f.write(f"Qwen3 Interpretability: {row['qwen3_correlation_score']:.4f}\n")
            f.write(f"TinyLlama Interpretability: {row['tinyllama_correlation_score']:.4f}\n")
            f.write("\n\n")

    print(f"✓ Report saved successfully")


# ============================================================================
# MAIN EXECUTION
# ============================================================================

def main():
    """Main execution function."""

    # Configuration
    QWEN_REPORT = '/kaggle/input/isscore/all_interpretibilityscore_qwen3-0.6B_2048.txt'
    TINYLLAMA_REPORT = '/kaggle/input/isscore/all_interpretabilityscore_tinyllama1.1B.txt'
    OUTPUT_TXT = '/kaggle/working/top10_similar_features_qwen3_vs_tinyllama.txt'
    OUTPUT_CSV = '/kaggle/working/top10_similar_features_qwen3_vs_tinyllama.csv'

    # Check input files
    if not os.path.exists(QWEN_REPORT):
        print(f"✗ Error: {QWEN_REPORT} not found!")
        return
    if not os.path.exists(TINYLLAMA_REPORT):
        print(f"✗ Error: {TINYLLAMA_REPORT} not found!")
        return

    print("Input files found:")
    print(f"  ✓ {QWEN_REPORT}")
    print(f"  ✓ {TINYLLAMA_REPORT}\n")

    # Parse reports
    print("Step 1: Parsing reports")
    print("-"*80)
    qwen_features = parse_interpretability_report(QWEN_REPORT)
    tinyllama_features = parse_interpretability_report(TINYLLAMA_REPORT)

    if len(qwen_features) == 0 or len(tinyllama_features) == 0:
        print("✗ Error: No features found!")
        return

    # Load model
    print("\nStep 2: Loading sentence transformer model")
    print("-"*80)
    print("Model: all-MiniLM-L6-v2")
    model = SentenceTransformer('all-MiniLM-L6-v2')
    print("✓ Model loaded")

    # Compute similarities
    print("\nStep 3: Computing similarities")
    print("-"*80)
    results_df = find_best_matches(qwen_features, tinyllama_features, model)

    # Save top 10 report
    print("\nStep 4: Saving results")
    print("-"*80)

    save_top10_report(results_df, OUTPUT_TXT)

    # Also save top 10 CSV
    top10_df = results_df.nlargest(10, 'similarity_score')
    top10_df.to_csv(OUTPUT_CSV, index=False)
    print(f"✓ CSV saved: {OUTPUT_CSV}")

    # Display summary
    print("\n" + "="*80)
    print("ANALYSIS COMPLETE!")
    print("="*80)

    print("\nTop 10 Most Similar Feature Pairs:")
    print(f"{'Rank':<6} {'Qwen3':<10} {'TinyLlama':<12} {'Similarity':<12} {'Sentiments':<20}")
    print("-"*80)

    for rank, (idx, row) in enumerate(top10_df.iterrows(), 1):
        sentiments = f"{row['qwen3_sentiment'][:3]}-{row['tinyllama_sentiment'][:3]}"
        print(f"{rank:<6} F{row['qwen3_feature_id']:<9} F{row['tinyllama_feature_id']:<11} "
              f"{row['similarity_score']:.4f}      {sentiments}")

    print(f"\nOutput files:")
    print(f"  • {OUTPUT_TXT} (detailed report)")
    print(f"  • {OUTPUT_CSV} (top 10 data)")
    print()


if __name__ == "__main__":
    main()

